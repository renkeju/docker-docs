

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ENTRYPOINT 入口点 &mdash; Docker alphe documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Docker
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/docker.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="dockerfile.html">Dockerfile 指令</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Docker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>ENTRYPOINT 入口点</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dockerfile/dockerfile_ENTRYPOINT.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="entrypoint">
<h1>ENTRYPOINT 入口点<a class="headerlink" href="#entrypoint" title="Permalink to this headline">¶</a></h1>
<p><span class="guilabel">ENTRYPOINT</span> 的格式和 <span class="guilabel">RUN</span> 指令格式一样，分别为 <strong>exec</strong> 格式和 <strong>shell</strong> 格式。</p>
<p><span class="guilabel">ENTRYPOINT</span> 的目的和 <span class="guilabel">CMD</span> 一样，都是在指定容器启动程序及参数。<span class="guilabel">ENTRYPOINT</span> 在运行时也可以替代，不过比 <span class="guilabel">CMD</span> 要略显繁琐，需要通过 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">container</span> <span class="pre">run</span></code> 的参数 <code class="docutils literal notranslate"><span class="pre">--entrypoint</span></code> 来指定。</p>
<p>当指定了 <span class="guilabel">ENTRYPOINT</span> 后，<span class="guilabel">CMD</span> 的含义就发生了改变，不再是直接的运行其命令，而是将 <span class="guilabel">CMD</span> 的内容作为参数传给 <span class="guilabel">ENTRYPOINT</span> 指令，换句话说实际执行时，将变为：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;
</pre></div>
</div>
<p>那么有了 <span class="guilabel">CMD</span> 后，为什么还要有 <span class="guilabel">ENTRYPOINT</span> 呢？这种 <code class="docutils literal notranslate"><span class="pre">&lt;ENTRTYPOINT&gt;</span> <span class="pre">&lt;CMD&gt;</span></code> 有什么好处？让我们来看几个场景。</p>
<ul>
<li><p>场景一：让镜像变成像命令一样使用</p>
<blockquote>
<div><p>假设我们需要一个得知自己当前公网IP的镜像，那么可以先用 <span class="guilabel">CMD</span> 来实现：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>FROM ubuntu:16.04
RUN apt-get update \
    &amp;&amp; apt-get install -y curl \
    &amp;&amp; rm -rf /var/lib/apt/lists/*
CMD [&quot;curl&quot;, &quot;-s&quot;, &quot;http://ip.cn&quot;]
</pre></div>
</div>
<p>假如我们使用 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">image</span> <span class="pre">build</span> <span class="pre">--tag=myip</span> <span class="pre">.</span></code> 来构建镜像的话，如果我们需要查询当前公网IP，只需要执行：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>docker container run --rm --name myip_test myip:1.0
当前 IP: 58.246.147.26 来自: 上海市 联通
</pre></div>
</div>
<p>嗯，这么看起来我们好像直接把镜像当作命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 <span class="guilabel">CMD</span> 中可以看到实质的命令时 curl，那么如果我们希望显示 HTTP 头信息，就需要加上 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 参数。那么我们可以直接加入 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 参数给 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">container</span> <span class="pre">run</span> <span class="pre">myip</span></code> 吗？</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>docker container run --rm --name myip_test myip:1.0 -i
docker: Error response from daemon: OCI runtime create failed: container_linux.go:348: starting container process caused &quot;exec: \&quot;-i\&quot;: executable file not found in $PATH&quot;: unknown.
</pre></div>
</div>
<p>我们可以看到可执行文件找不到的报错，<code class="docutils literal notranslate"><span class="pre">executable</span> <span class="pre">file</span> <span class="pre">not</span> <span class="pre">found</span></code> 。之前我们说过，跟在镜像名后面的是 command，运行时会替换 <span class="guilabel">CMD</span> 的默认值。因此这里的 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 替换了原来的 <span class="guilabel">CMD</span> ，而不是添加在原来的 <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-s</span> <span class="pre">http://ip.cn</span></code> 后面。而 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 根本不是命令，所以自然找不到。</p>
<p>那么如果我们希望加入 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 这参数，我们就必须重新完整的输入这个命令：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ docker container run --rm --name myip_test myip:1.0 curl -s http://ip.cn -i
HTTP/1.1 200 OK
Date: Thu, 01 Nov 2018 02:59:52 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
Set-Cookie: __cfduid=d8b77ba972fb91bec979f9a212ceca6841541041192; expires=Fri, 01-Nov-19 02:59:52 GMT; path=/; domain=.ip.cn; HttpOnly
Server: cloudflare
CF-RAY: 472b1b9af36b9619-SJC

当前 IP: 58.246.147.26 来自: 上海市 联通
</pre></div>
</div>
<p>这显然不是很好的解决方案，而使用 <span class="guilabel">ENTRYPOINT</span> 就可以解决这个问题。现在我们重新用 <span class="guilabel">ENTRYPOINT</span> 来实现这个镜像：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>FROM ubuntu:16.04

RUN apt-get update \
    &amp;&amp; apt-get install -y curl \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

ENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://ip.cn&quot; ]
</pre></div>
</div>
<p>这次我们再来尝试直接使用 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">container</span> <span class="pre">run</span> <span class="pre">myip</span> <span class="pre">-i</span></code> 。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ docker container run --rm --name myip_test myip:1.1
当前 IP: 58.246.147.26 来自: 上海市 联通

$ docker container run --rm --name myip_test myip:1.1 -i
HTTP/1.1 200 OK
Date: Thu, 01 Nov 2018 03:17:16 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
Set-Cookie: __cfduid=d89a29d9467d6f00d7856b8a8f22d10791541042236; expires=Fri, 01-Nov-19 03:17:16 GMT; path=/; domain=.ip.cn; HttpOnly
Server: cloudflare
CF-RAY: 472b351850169668-SJC

当前 IP: 58.246.147.26 来自: 上海市 联通
</pre></div>
</div>
<p>可以看到，这次成功了。这是因为当存在 <span class="guilabel">ENTRYPOINT</span> 后，<span class="guilabel">CMD</span> 的内容将会作为参数传给 <span class="guilabel">ENTRYPOINT</span>，而这里 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 就是新的 <span class="guilabel">CMD</span>，因为会作为参数传给 curl，从而达到了我们预期的效果。</p>
</div></blockquote>
</li>
<li><p>场景二：应用运行前的准备工作</p>
<blockquote>
<div><p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>
<p>比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>
<p>此外，可能希望避免使用 <span class="guilabel">root</span> 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务之外，其他命令依旧可以使用 root 身份执行，方便调试等。</p>
<p>这些准备工作是和容器 <span class="guilabel">CMD</span> 无关的，无论 <span class="guilabel">CMD</span> 是什么，都需要事先进行一个预处理工作。这种情况下，可以写一个脚本，然后放入 <span class="guilabel">ENTRYPOINT</span> 中执行，而这个脚本会将接收到的参数（也就是 <span class="guilabel">&lt;CMD&gt;</span>）作为命令，在脚本最后执行。比如官方镜像 <a class="reference external" href="https://github.com/docker-library/redis/blob/dc6dc737baa434528ce31948b22b4c6ccc78793a/5.0/Dockerfile">redis Dockerfile</a> 中就是这么做的：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>FROM alpine:3.4
...
RUN addgroup -S redis &amp;&amp; adduser -S -G redis redis
...
ENTRYPOINT [&quot;docker-entrypoint.sh&quot;]

EXPOSE 6379
CMD [ &quot;redis-server&quot; ]
</pre></div>
</div>
<p>可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 <span class="guilabel">ENTRYPOINT</span> 为 <code class="docutils literal notranslate"><span class="pre">docker-entrypoint.sh</span></code> 脚本。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">set</span> -e

<span class="c1"># first arg is `-f` or `--some-option`</span>
<span class="c1"># or first arg is `something.conf`</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">#-</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">%.conf</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">set</span> -- redis-server <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># allow the container to be started with `--user`</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s1">&#39;redis-server&#39;</span> -a <span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    find . <span class="se">\!</span> -user redis -exec chown redis <span class="s1">&#39;{}&#39;</span> +
    <span class="nb">exec</span> gosu redis <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>该脚本的内容就是根据 <span class="guilabel">CMD</span> 的内容来判断，如果是 <code class="docutils literal notranslate"><span class="pre">redis-server</span></code> 的话，则切换到 <code class="docutils literal notranslate"><span class="pre">redis</span></code> 用户身份启动服务，否则依旧使用 root 身份执行。比如：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ docker container run --detach --publish-all --name kvstore redis:4.0-alpine
1656bd2427fcc96e3e9dbdaf0e498786ca8817b5bb97e200476c555a117964c5

$ docker container exec kvstore id
uid=0(root) gid=0(root)
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Renkeju

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>