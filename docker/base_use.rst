基础用法
~~~~~~~~~~~~~

安装 
^^^^^^^

* 依赖的基础环境

    * 64 bits CPU
    * Linux Kernel 3.10+
    * Linux Kernel cgroups and namespaces

* CentOS 7+

    * "Extras" repository

        不建议通过 CentOS 默认仓库安装 Docker，版本过旧

* Docker Daemon

    * systemctl start docker.service

个人推荐使用 daocloud 安装 docker，安装方式详见 `daocloud 产品中心 docker 安装方式 <https://download.daocloud.io/Docker_Mirror/Docker>`_

docker 程序环境
^^^^^^^^^^^^^^^^^^^^

docker 环境配置都可以由 ``/etc/docker/daemon.none`` 这个文件所控制。docker 安装后默认没有 daemon.none 这个配置文件，需要手工创建。

一般情况下，配置文件 daemin.none 中配置的项目参数，在启动参数中同样适用，有些可能不一样（具体可以查看官方文档），但需要注意的一点，配置文件中如果已经由摸个配置项，则无法在启动参数中增加，会出现冲突的错误。

.. attention:: 

    如果在 daemon.none 文件中进行配置，需要 docker 版本高于 1.12.6（在这个版本不生效，1.13.1 以上是生效的）

* 指定网桥网络

    给 docker0 分配特定的IP地址，并设置子网掩码

    .. code-block:: none

        {
            "bip": "192.168.199.5/24"
        }

* 指定网桥网络范围

    限制 docker0 分配给容器的IP的范围。必须是 docker0 所在网络范围内的一个子网，或是由 ``--bridge`` 指定的网桥的IP所在网络范围内的一个子网。此后，为容器分配IP时就会从这个范围内选择一个可用的IP地址。

    .. code-block:: none
    
        {
            "fixed-cidr": "10.20.0.0/16",
            "fixed-cide-v6": "2001:db8::/64"
        }

* 最大传输单元

    覆盖 docker0 默认的最大传输单元

    .. code-block:: none
      
        {
            "mtu": 1500
        }

* 指定 DNS

    .. code-block:: none

        {
            "dns": ["8.8.8.8", "8.8.4.4"]
        }

* 指定监听模式

    .. code-block:: none

        {
            "hosts": ["tcp://0.0.0.0:2376", "unix:///var/run/docker.sock"]
        }

* 镜像加速器

    .. code-block:: none

        // 配置单个
        {
            "registry-mirrors": ["https://registry.docker-cn.com"]
        }

        // 配置多个
        {
            "registry-mirrors": ["https://registry.docker-cn.com", "https://docker.mirrors.ustc.edu.cn/"]
        }

* 日志

    log-level 的有效值包括：

    * debug
    * info
    * warn
    * error
    * fatal

    .. code-block:: none

        {
            "debug": true,
            "log-level": "info"
        }

    指定日志格式、大小和数量等。

    .. code-block:: none

        {
            "log-driver": "json-file",
            "log-opts": {
                "max-size": "5m",
                "max-file": "5"
            }
        }

* 监控 Prometheus

    https://docs.docker.com/engine/admin/prometheus/#configure-docker

    .. code-block:: none

        {
            "metrics-addr": "127.0.0.1:9323",
            "experimental": true
        }

* 保持容器在线

    https://docs.docker.com/engine/admin/live-restore/#enable-the-live-restore-option

    当 dockerd 进程死掉后，依旧保持容器存活。

    .. code-block:: none

        {
            "live-restore": true
        }

    Linux 重载 docker daemon

    ..  code-block:: bash 

        $ sudo kill -SIGHUP $(pidof dockerd)

* 信任私有仓库地址

    docker 默认只信任 HTTPS 协议私有镜像仓库，如果搭建内网私有镜像仓库使用 HTTP 协议，需要指定信任仓库。

    .. code-block:: none

        {
            "insecure-registries": [ "10.10.172.203:5000" ]
        }

* 设置 镜像、容器、卷 存放目录和驱动

    https://docs.docker.com/engine/admin/systemd/#runtime-directory-and-storage-driver

    下述两个参数可以单独使用

    .. code-block:: none

        {
            "graph": "/mnt/docker-data",
            "storage-driver": "overlay"
        }

    graph 设置存放目录 —— Docker Root Dir /mnt/docker-data
    storage-driver 设置存储驱动 —— Storage Driver overlay

* user namespace remap

    https://docs.docker.com/engine/security/userns-remap/#enable-userns-remap-on-the-daemon

    安全设置：用户空间重映射

    userns-remap 的值可以是 如果值字段 只有 一个值，那么该字段表示组。如果需要同时指定 用户和组，需要使用 冒号 分割，格式为 用户:组

    * 组
    * 用户:组
    * 组 或 用户 的值可以是组或用户的 名称 或 ID

        * testuser
        * testuser:testuser
        * 1001
        * 1001:1001
        * testuser:1001
        * 1001:testuser

    .. code-block:: none

        {
            "userns-remap": "testuser"
        }

        // 或同时指定 用户和组，且使用 名称和ID
        {
            "userns-remap": "testuser:1001"
        }
        
    .. code-block:: none

        $ dockerd --userns-remap="testuser:testuser"

    .. note:: 

        userns-remap 使用不多，但并不是不重要。目前不是默认启用的原因时因为一些应用会假定 uid 0 的用户拥有特殊能力，从而导致假定失败，然后报错退出。所以如果要启用 user id remap，你要充分测试一下。但是启用 uid remap 的安全性提高是明显的。

配置完成后我们可以通过命令 ``docker info`` 查看 docker 详细信息

常用操作
^^^^^^^^^^^^^^

+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|  command  |                   content                    | subobject  |                                                   subobject content                                                   |
+===========+==============================================+============+=======================================================================================================================+
|   config  |            Manage Docker configs             |   create   |                              Create a configuration file from a file or STDIN as content                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                            Display detailed information on one or more configuration files                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                      List configs                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                         Remove one or more configuration files                                        |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
| container |               Manage container               |   attach   |                     Attach local standard input, output, and error streams to a running container                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   commit   |                                     Create a new image from a container's changes                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     cp     |                            Copy files/folders between a container and the local filesystem                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   create   |                                                 Create a new container                                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    diff    |                          Inspect changes to files or directories on a container's filesystem                          |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    exec    |                                          Run a command in a running container                                         |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   export   |                                    Export a container's filesystem as a tar archive                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                 Display detailed information on one or more containers                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    kill    |                                          Kill one or more running containers                                          |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    logs    |                                             Fetch the logs of a container                                             |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                    List containers                                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   pause    |                                   Pause all processes whitin one or more containers                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    port    |                               List port mappings or a specific mapping for the container                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   prune    |                                             Remove all stopped containers                                             |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   rename   |                                                   Rename a container                                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  restart   |                                             Restart one or more containers                                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                              Remove one or more container                                             |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    run     |                                            Run a command in a new container                                           |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   start    |                                          Start one or more stopped containers                                         |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   stars    |                            Display a live stream of container(s) resource usage statistics                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    stop    |                                          Stop one or more running containers                                          |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    top     |                                     Display the running processes of a containers                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  unpause   |                                  Unpause all processes within one or more containers                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   update   |                                     Update configuration of one or more containers                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    wait    |                          Block until one or more containers stop, then print their exit codes                         |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   image   |                Manage images                 |   build    |                                             Build an image from Dockerfile                                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  history   |                                              Show the history of an image                                             |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   import   |                           Import the containers from a tarball to create a filesystem image                           |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                   Display detailed information on onw or more images                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    load    |                                       Load an image from a tar archive or STDIN                                       |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                      List images                                                      |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   prune    |                                                  Remove unused images                                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    pull    |                                     Pull an image or a repository from a registry                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    push    |                                      Push an image or a repository to a registry                                      |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                               Remove one or more images                                               |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    save    |                        Save one or more images to a tar archive (streamed to STDOUT by default)                       |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    tag     |                                 Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE                                 |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|  network  |               Manage networks                |  connect   |                                            Connect a container to a network                                           |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   create   |                                                    Create a network                                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              | disconnect |                                Disconnect detailed information on one or more networks                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on one or more networks                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                     List networks                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   prune    |                                               Remove all unused networks                                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                              Remove one or more networks                                              |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|    node   |              Manage Swarm node               |   deamon   |                                   Demote one or more nodes from manager in the swarm                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                   Display detailed information on one or more nodes                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                List nodes in the swarm                                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  promote   |                                   Promote one or more nodes to manager in the swarm                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ps     |                           List tasks running on one or more nodes, defaults to current node                           |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                        Remove one or more nodes from the swarm                                        |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   update   |                                                     Update a node                                                     |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   plugin  |                Manage plugins                |   create   | Create a plugin from a rootfs and configuration. Plugin data directory must contain config.json and rootfs directory. |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  disable   |                                                    Disable a plugin                                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   enable   |                                                    Enable a plugin                                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on one or more plugins                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  install   |                                                    Install a plugin                                                   |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                      List plugins                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    push    |                                              Push a plugin to a registry                                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                               Remove one or more plugin                                               |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    set     |                                              Change settings for a plugin                                             |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  upgrade   |                                               Upgrade an existing plugin                                              |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   secret  |            Manage Docker secrets             |   create   |                                    Create a secret from a file or STDIN as content                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on onw or more secrets                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                      List secrets                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                               Remove one or more secrets                                              |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|  service  |                Manage service                |   create   |                                                  Create a new service                                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on one or more services                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    logs    |                                          Fetch the logs of a  service or task                                         |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                     List services                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ps     |                                         List the tasks of one or more services                                        |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                              Remove one or more services                                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  rollback  |                                      Revert changes to a service's configuration                                      |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   scale    |                                       Scale one or multiple replicated services                                       |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   update   |                                                    Update a service                                                   |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   stack   |             Manage Docker stacks             |   create   |                                                  Create a new service                                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on one or more services                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    logs    |                                          Fetch the logs of a service or task                                          |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                     List services                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ps     |                                         List the tasks of one or more services                                        |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                              Remove one or more services                                              |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  rollback  |                                      Revert changes to a service's configuration                                      |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   scale    |                                       Scale one or multiple replicated services                                       |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   update   |                                                   Update a services                                                   |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   swarm   |                 Manage Swarm                 |     ca     |                                             Display and rotate the root CA                                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    init    |                                                   Initialize a swarm                                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    join    |                                         Join a swarm as a node and/or manager                                         |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              | join-token |                                                  Manager join tokens                                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   leave    |                                                    Leave the swarm                                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   unlock   |                                                      Unlock swarm                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              | unlock-key |                                                 Manage the unlock key                                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   update   |                                                    Update the swarm                                                   |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   system  |                Manage Docker                 |     df     |                                                 Show docker disk usage                                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   events   |                                          Get real time events from the server                                         |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    info    |                                            Display system-wide information                                            |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   prune    |                                                   Remove unused data                                                  |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   trust   | Manage trust on Docker images (experimental) |    key     |                                  Manage keys for signing Docker images (experimental)                                 |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   signer   |                               Manage entities who can sign Docker images (experimental)                               |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                 Return low-level information about keys and signatures                                |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   revoke   |                                               Remove trust for an image                                               |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    sign    |                                                     Sign an image                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |    view    |                                 Display detailed information about keys and signatures                                |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+
|   volume  |                Manage volumes                |   create   |                                                    Create a volume                                                    |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |  inspect   |                                  Display detailed information on one or more volumes                                  |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     ls     |                                                      List volumes                                                     |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |   prune    |                                               Remove all unused volumes                                               |
|           |                                              +------------+-----------------------------------------------------------------------------------------------------------------------+
|           |                                              |     rm     |                                               Remove one or more volumes                                              |
+-----------+----------------------------------------------+------------+-----------------------------------------------------------------------------------------------------------------------+

状态转换
^^^^^^^^^^^^

.. image:: /images/container/docker/docker_event_stats.jpg

